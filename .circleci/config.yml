version: 2.1

jobs:
  sample:
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: medium
    steps:
      - run: docker info
      - run:
          name: run Docker container (background)
          command: |
            docker pull kelvintaywl/fancy-nginx

            # NOTE: our container needs to remain running,
            # in order for us to docker cp or docker exec
            docker run --detach --name nginx -p 5050:80 kelvintaywl/fancy-nginx
      - run:
          name: wait for Docker container
          command: |
            docker ps -a

            # alternative:
            #   dockerize -wait http://127.0.0.1:5050 -timeout 10s
            N=10
            while [ $N -gt 0 ]
            do
              if $(docker ps -f name=nginx | grep 'nginx'); then
                echo "Container is up!"
                exit 0
              fi
              echo "Container is not up yet; waiting to retry..."
              N=$(( $N - 1 ))
              sleep 2
            done
            exit 1
      - run:
          name: Inspect files
          command: |
            # the container has HTML files under /usr/share/nginx/html folder
            # See https://github.com/kelvintaywl/whale-of-a-time/blob/master/Dockerfile
            docker exec nginx ls /usr/share/nginx/html/

            docker cp nginx:/usr/share/nginx/html/index.html ./downloaded.html

            cat ./downloaded.html

workflows:
  main:
    jobs:
      - sample
